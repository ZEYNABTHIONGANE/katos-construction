rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Collection users - Allow queries for username lookup
    match /users/{document=**} {
      // Allow unauthenticated list operations for username lookup during authentication
      allow list: if true;
    }

    // Collection users - Accès authentifié uniquement
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;
      allow update: if request.auth != null;
      allow create: if request.auth != null &&
                      request.resource.data.keys().hasAll(['role', 'clientId']) &&
                      request.resource.data.role == 'client';
      allow delete: if request.auth != null;

      // Special rule for username lookup during login
      allow read: if resource.data.keys().hasAll(['username', 'email']) &&
                     resource.data.username is string &&
                     resource.data.username.matches('^CLI[0-9]{9}$');
    }

    // Collection clients
    match /clients/{clientId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      allow list: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Collection projects - MUST BE PUBLIC for the Showcase/Catalog
    match /projects/{projectId} {
      // Allow public read so the catalog works for everyone
      allow read: if true;
      // Writing requires authentication (Backoffice)
      allow create, update, delete: if request.auth != null;
    }

    // Allow listing projects publicly
    match /projects/{document=**} {
      allow list: if true;
    }

    // Collection materials - ALSO PUBLIC for the Catalog
    match /materials/{materialId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null;
    }

    // Allow listing materials publicly
    match /materials/{document=**} {
      allow list: if true;
    }

    // Collection invitations
    match /invitations/{invitationId} {
      allow read, create, update, delete: if request.auth != null;
      allow list: if request.auth != null;
      
      // Allow client to read their own invitation by email
      allow read: if request.auth != null &&
                     request.auth.token.email == resource.data.email;
    }

    // Collection invitationCodes
    match /invitationCodes/{codeId} {
      allow read, update, list: if true;
      allow create, delete: if request.auth != null;
    }

    // Collection settings - Paramètres de l'application (Showcase, etc.)
    match /settings/showcase {
      // Allow public read for the mobile app
      allow read: if true;
      // Only authenticated users can update the showcase
      allow write: if request.auth != null;
    }

    // Collection chantiers - Accès pour chefs et clients
    match /chantiers/{chantierId} {
      allow read, write: if request.auth != null;
      allow list: if request.auth != null;
      
      // Sub-collection feedbacks
      match /feedbacks/{feedbackId} {
        allow read, write: if request.auth != null;
      }
    }

    // Collection clientSelections
    match /clientSelections/{selectionId} {
      allow read, list, create, update: if request.auth != null;
    }

    // Collection documents
    match /documents/{documentId} {
      allow read, list, create, update, delete: if request.auth != null;
    }

    // Collection documentNotifications
    match /documentNotifications/{notificationId} {
      allow read, list, create, update, delete: if request.auth != null;
    }

    // Collection prospects - Public creation permitted, read restricted to admins
    match /prospects/{prospectId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null;
      allow list: if request.auth != null;
    }
    
    // Default rules for any other documents
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}